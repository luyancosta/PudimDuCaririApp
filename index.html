<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pudim Du Cariri - ERP Final</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');

        :root {
            --bg-color: #F3F4F6;
            --primary: #D97706; --primary-hover: #B45309; 
            --secondary: #1F2937;
            --text-main: #111827; --text-muted: #6B7280;
            --card-bg: #FFFFFF; --border: #E5E7EB;
            --success: #10B981; --danger: #EF4444; --info: #3B82F6; --warning: #F59E0B;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); font-size: 14px; padding-bottom: 60px; }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #FDE68A; display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column;}
        .login-box { background: var(--card-bg); padding: 2.5rem; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; border-top: 6px solid var(--primary);}
        .login-box h1 { color: var(--secondary); margin-bottom: 1.5rem; font-weight: 800; font-size: 1.8rem; letter-spacing: -0.05em; }
        .login-box input { margin-bottom: 1rem; width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; outline: none; font-size: 1rem; transition: 0.2s;}
        .login-box input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(217,119,6,0.2); }
        .login-box button { width: 100%; background: var(--primary); color: white; padding: 0.9rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: 0.3s;}
        #login-error { color: #991B1B; font-size: 0.85rem; margin-top: 15px; display: none; padding: 12px; background: #FEE2E2; border-radius: 8px; text-align: left; border: 1px solid #F87171;}

        /* LAYOUT */
        #app-container { display: none; }
        header { background-color: var(--secondary); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; position: sticky; top: 0; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        header h1 { font-size: 1.2rem; font-weight: 700; color: #FDE68A; margin: 0; }
        .header-actions button { background-color: rgba(255,255,255,0.1); color: white; border: none; padding: 0.5rem 0.8rem; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.8rem; }
        #btn-logout { background-color: var(--danger) !important; }

        /* TABS */
        .tabs { display: flex; overflow-x: auto; background: var(--card-bg); padding: 0 0.5rem; border-bottom: 1px solid var(--border); margin-bottom: 1rem; }
        .tabs::-webkit-scrollbar { height: 0px; }
        .tab-btn { background: none; border: none; padding: 1rem; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); }

        .content { padding: 0 1rem; max-width: 1600px; margin: 0 auto; display: none; animation: fadeIn 0.3s ease-in-out; }
        .content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & GRIDS */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.8rem; margin-bottom: 1.5rem; }
        .card { background: var(--card-bg); padding: 1rem; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-left: 4px solid var(--primary); display: flex; flex-direction: column; justify-content: space-between; }
        .card h3 { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.4rem; text-transform: uppercase; font-weight: 700; }
        .card p { font-size: 1.3rem; font-weight: 800; color: var(--text-main); line-height: 1.1; }
        .card.destaque { background: #111827; color: white; border-left-color: #10B981; }
        .card.destaque h3 { color: #9CA3AF; }
        .card.destaque p { color: #10B981; font-size: 2rem; }

        /* PAGAMENTO MINI CARDS (Horizontal Scroll) */
        .payment-summary-grid { display: flex; gap: 10px; margin-bottom: 1.5rem; overflow-x: auto; padding-bottom: 10px; scroll-behavior: smooth; }
        .payment-summary-grid::-webkit-scrollbar { height: 4px; }
        .payment-summary-grid::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }
        .mini-card { min-width: 130px; background: white; padding: 12px; border-radius: 10px; border: 1px solid var(--border); border-top: 4px solid var(--primary); text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .mini-card span { display: block; font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 5px; }
        .mini-card strong { display: block; font-size: 1.1rem; color: var(--secondary); font-weight: 800; }

        /* FORMS */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.8rem; }
        .form-group { margin-bottom: 0.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.2rem; font-size: 0.75rem; color: var(--text-muted); }
        input, select { width: 100%; padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; outline: none; font-size: 0.9rem; background: #F9FAFB; }
        input:focus, select:focus { border-color: var(--primary); background: #FFF; }
        .btn-submit { background: var(--primary); color: white; padding: 0.8rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.95rem; margin-top: 1rem; width: 100%; text-transform: uppercase; }

        /* TABLES */
        .table-container { overflow-x: auto; background: var(--card-bg); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 700px; font-size: 0.85rem; }
        .table-compact table { min-width: 100% !important; } 
        th, td { padding: 0.7rem 0.8rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #F3F4F6; color: var(--secondary); font-weight: 700; text-transform: uppercase; font-size: 0.7rem; }
        tbody tr:nth-child(even) { background-color: #F9FAFB; }
        .tr-totais td { background-color: #1F2937 !important; color: #FDE68A !important; font-weight: 800; border-top: 2px solid #000; }

        /* BUTTONS & ICONS */
        .btn-icon { width: 30px; height: 30px; border-radius: 5px; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; color: white; margin-right: 3px; font-size: 0.9rem; }
        .btn-edit { background: var(--info); }
        .btn-delete { background: var(--danger); }
        .btn-pay { background: var(--success); width: auto; padding: 0 8px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; height: 26px; }
        .btn-action-small { margin-top: 5px; padding: 8px 12px; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: 600; width: 100%; text-transform: uppercase; font-size: 0.75rem; cursor: pointer; }

        /* ESTOQUE */
        .status-green { color: var(--success); font-weight: 700; }
        .status-red { color: var(--danger); font-weight: 700; }
        .estoque-card h3 { display: flex; align-items: center; justify-content: center; height: 35px; text-align: center; }
        .btn-edit-stock { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 50%; border: none; cursor: pointer; }

        /* UTILS */
        .section-title { margin-bottom: 1rem; color: var(--secondary); border-bottom: 2px solid var(--border); padding-bottom: 0.4rem; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; font-weight: 800; }
        .global-title { background: var(--secondary); color: #FDE68A; padding: 0.6rem; border-radius: 6px; margin: 1.5rem 0 1rem 0; text-align: center; font-size: 0.95rem; font-weight: 700; text-transform: uppercase; }
        .toast { visibility: hidden; min-width: 250px; background-color: var(--secondary); color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 10000; bottom: 20px; right: 20px; font-weight: 600; opacity: 0; transition: 0.3s; transform: translateY(20px); }
        .toast.show { visibility: visible; opacity: 1; transform: translateY(0); }

        body.viewer-mode .btn-submit, body.viewer-mode .btn-delete, body.viewer-mode .btn-edit, 
        body.viewer-mode .btn-edit-stock, body.viewer-mode .btn-action-small, body.viewer-mode .btn-pay { display: none !important; }
    </style>
</head>
<body>

    <div id="toast" class="toast">Salvo com sucesso!</div>

    <div id="login-screen">
        <div class="login-box">
            <h1>üçÆ Pudim Du Cariri</h1>
            <p style="margin-bottom: 1.5rem; color: var(--text-muted);">ERP de Gest√£o</p>
            <input type="email" id="login-email" placeholder="E-mail">
            <input type="password" id="login-password" placeholder="Senha">
            <button id="btn-login-action" onclick="fazerLogin()">ENTRAR</button>
            <p id="login-error"></p>
        </div>
    </div>

    <div id="app-container">
        <header>
            <h1>üçÆ Pudim Du Cariri</h1>
            <div class="header-actions">
                <span id="user-badge" style="font-size: 0.8rem; color: #FDE68A; font-weight: 600; margin-right: 10px;"></span>
                <button onclick="exportDataBlob()">üíæ Backup</button>
                <button onclick="document.getElementById('importFile').click()">üìÇ Restaurar</button>
                <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
                <button id="btn-logout" onclick="fazerLogout()">Sair</button>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard-geral')">üìä Dashboards</button>
            <button class="tab-btn" onclick="switchTab('receber')">‚è≥ A Receber</button>
            <button class="tab-btn" onclick="switchTab('estoque')">üì¶ Estoque</button>
            <button class="tab-btn" onclick="switchTab('vendas')">Varejo</button>
            <button class="tab-btn" onclick="switchTab('atacado')">Atacado</button>
            <button class="tab-btn" onclick="switchTab('rateio')">Rateio</button>
            <button class="tab-btn" onclick="switchTab('despesas')">Despesas</button>
            <button class="tab-btn" onclick="switchTab('extrato')">Extrato</button>
            <button class="tab-btn" onclick="switchTab('investimentos')">Invest.</button>
            <button class="tab-btn" onclick="switchTab('config')">‚öôÔ∏è Config</button>
        </div>

        <div id="dashboard-geral" class="content active">
            <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; margin-bottom: 1.5rem; background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                <div style="display: flex; flex-direction: column;">
                    <label style="margin: 0 0 5px 0;">Filtrar M√™s:</label>
                    <input type="month" id="dash-filter-month" onchange="updateDashboard()" style="width: 160px; margin: 0;">
                </div>
                <button class="btn-action-small" style="width: auto; background: var(--text-muted); margin: 0; padding: 10px;" onclick="limparFiltro()">Limpar</button>
                <button class="btn-action-small" style="width: auto; margin: 0 0 0 auto; background: #25D366; padding: 10px 20px; font-size: 0.85rem;" onclick="enviarFechamentoWhatsApp()">üì± Enviar Fechamento (WhatsApp)</button>
            </div>

            <h2 class="section-title" style="color: var(--success); border-color: var(--success);">üí∞ CAIXA REAL (F√çSICO)</h2>
            <div class="dashboard-grid">
                <div class="card destaque" style="grid-column: 1 / -1; flex-direction: row; align-items: center; justify-content: space-between; padding: 1.5rem;">
                    <div><h3>Dinheiro Total Dispon√≠vel</h3><p id="global-total-conta">R$ 0,00</p></div>
                </div>
            </div>

            <div class="global-title">üîí DIVIS√ÉO DOS SALDOS</div>
            <div id="grid-saldos-globais"></div>

            <h2 class="section-title" style="margin-top: 2.5rem;">üõí Performance VAREJO</h2>
            <div class="dashboard-grid">
                <div class="card"><h3>Fat. Bruto</h3><p id="v-dash-bruto">R$ 0,00</p></div>
                <div class="card"><h3>Fat. L√≠quido</h3><p id="v-dash-liquido">R$ 0,00</p></div>
                <div class="card"><h3>Qtd. Vendida</h3><p id="v-dash-qtd">0</p></div>
                <div class="card" style="border-left-color: #10B981;"><h3>Lucro L√≠quido</h3><p id="v-dash-lucro-restante" style="color: #10B981;">R$ 0,00</p></div>
            </div>

            <h2 class="section-title" style="margin-top: 2rem;">üì¶ Performance ATACADO</h2>
            <div class="dashboard-grid">
                <div class="card"><h3>Fat. L√≠quido</h3><p id="a-dash-liquido">R$ 0,00</p></div>
                <div class="card"><h3>Qtd. Vendida</h3><p id="a-dash-qtd">0</p></div>
            </div>
        </div>

        <div id="vendas" class="content">
            <h2 class="section-title">üõí Nova Venda Varejo</h2>
            
            <div class="payment-summary-grid">
                <div class="mini-card" style="border-top-color: #3B82F6;"><span>PIX (Pessoal)</span><strong id="v-sum-pix-p">R$ 0,00</strong></div>
                <div class="mini-card" style="border-top-color: #10B981;"><span>PIX (Asaas)</span><strong id="v-sum-pix-a">R$ 0,00</strong></div>
                <div class="mini-card" style="border-top-color: #F59E0B;"><span>Dinheiro</span><strong id="v-sum-dinheiro">R$ 0,00</strong></div>
                <div class="mini-card" style="border-top-color: #8B5CF6;"><span>Cr√©dito</span><strong id="v-sum-credito">R$ 0,00</strong></div>
                <div class="mini-card" style="border-top-color: #6B7280;"><span>D√©bito</span><strong id="v-sum-debito">R$ 0,00</strong></div>
                <div class="mini-card" style="border-top-color: #6B7280;"><span>Online</span><strong id="v-sum-online">R$ 0,00</strong></div>
            </div>

            <div class="card" style="margin-bottom: 2rem;">
                <div class="form-grid">
                    <div class="form-group"><label>Data</label><input type="date" id="v-data"></div>
                    <div class="form-group"><label>Produto</label><select id="v-produto"><option value="Unidade">Unidade</option><option value="Combo">Combo (3 und)</option></select></div>
                    <div class="form-group"><label>Qtd</label><input type="number" id="v-qtd" value="1" min="1"></div>
                    <div class="form-group"><label>Desc. (R$)</label><input type="number" id="v-desconto" step="0.01" value="0"></div>
                    <div class="form-group">
                        <label>Pagamento</label>
                        <select id="v-pgto" onchange="toggleAsaas()">
                            <option value="PIX">PIX</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Credito Insercao">Cr√©dito (Ins)</option>
                            <option value="Credito Aproximacao">Cr√©dito (Apr)</option>
                            <option value="Debito Insercao">D√©bito (Ins)</option>
                            <option value="Debito Aproximacao">D√©bito (Apr)</option>
                            <option value="Cartao Online">Link Online</option>
                        </select>
                    </div>
                    <div class="form-group" id="asaas-group" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="v-asaas" style="width: 18px; height:18px;">
                        <label for="v-asaas" style="margin: 0; color: #D97706; font-weight:700">PIX via Asaas?</label>
                    </div>
                    <div class="form-group"><label>Taxa Entrega</label><input type="number" id="v-entrega" step="0.01" value="0"></div>
                </div>
                <button class="btn-submit" id="btn-submit-vendas" onclick="addVenda()">Lan√ßar Venda</button>
            </div>

            <div class="table-container">
                <table>
                    <thead><tr><th>#</th><th>Data</th><th>Produto</th><th>Pgto</th><th>L√≠quido</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="tbody-vendas"></tbody>
                </table>
            </div>
        </div>

        <div id="receber" class="content"><h2 class="section-title">‚è≥ A Receber</h2><div class="table-container"><table><thead><tr><th>Data</th><th>Cliente</th><th>Valor</th><th>A√ß√£o</th></tr></thead><tbody id="tbody-receber"></tbody></table></div></div>
        <div id="estoque" class="content"><h2 class="section-title">üì¶ Estoque</h2><div class="dashboard-grid" id="grid-estoque"></div><div style="display:flex; gap:1rem; flex-wrap:wrap;"><div class="card" style="flex:1"><h3>Receita</h3><input type="date" id="prod-data"><input type="number" id="prod-qtd" value="1"><button class="btn-submit" onclick="addProducao()">Bater</button></div></div><div class="table-container mt-2"><table><thead><tr><th>Data</th><th>Qtd</th><th>A√ß√£o</th></tr></thead><tbody id="tbody-producoes"></tbody></table></div></div>
        
        <div id="atacado" class="content"><h2 class="section-title">üì¶ Atacado</h2>
            <div class="payment-summary-grid">
                <div class="mini-card"><h4>L√≠quido</h4><strong id="a-card-liq">R$ 0,00</strong></div>
            </div>
            <div class="card"><div class="form-grid"><input type="date" id="a-data"><input type="text" id="a-cliente" placeholder="Cliente"><input type="number" id="a-qtd" placeholder="Qtd"><input type="number" id="a-valor" placeholder="Valor Un."><select id="a-status"><option value="PAGO">Pago</option><option value="N√ÉO PAGO">Pendente</option></select></div><button class="btn-submit" onclick="addAtacado()">Salvar</button></div><div class="table-container mt-2"><table><thead><tr><th>Data</th><th>Cliente</th><th>Qtd</th><th>Total</th><th>Status</th><th>A√ß√£o</th></tr></thead><tbody id="tbody-atacado"></tbody></table></div></div>
        
        <div id="rateio" class="content"><h2 class="section-title">üìä Rateio Detalhado</h2><div class="table-container"><table><thead><tr><th>#</th><th>Data</th><th>Liq</th><th>Ins</th><th>Gerais</th><th>M√£o</th><th>Lucro</th><th>Giro</th><th>Fundo</th><th>Lu</th><th>Bea</th></tr></thead><tbody id="tbody-rateio-varejo"></tbody></table></div></div>
        <div id="despesas" class="content"><h2 class="section-title">üí∏ Despesas</h2><div class="card"><div class="form-grid"><input type="date" id="d-data"><input type="text" id="d-item" placeholder="Item"><input type="number" id="d-qtd" placeholder="Qtd" step="0.01"><input type="number" id="d-valor" placeholder="Vl. Unit" step="0.01"><select id="d-categoria"><option value="INSUMOS">Insumos</option><option value="EMBALAGEM">Embalagem</option><option value="GASTOS GERAIS">Gerais</option><option value="MARKETING">Marketing</option></select></div><button class="btn-submit" onclick="addDespesa()">Salvar</button></div><div class="table-container mt-2"><table><thead><tr><th>Data</th><th>Item</th><th>Total</th><th>Cat</th><th>A√ß√£o</th></tr></thead><tbody id="tbody-despesas"></tbody></table></div></div>
        <div id="extrato" class="content"><h2 class="section-title">üìë Extrato de Saques</h2><div class="table-container"><table><thead><tr><th>Data</th><th>Origem</th><th>Valor</th><th>A√ß√£o</th></tr></thead><tbody id="tbody-pagamentos"></tbody></table></div></div>
        <div id="investimentos" class="content"><h2 class="section-title">üìà Investimentos</h2><div class="table-container"><table><thead><tr><th>Data</th><th>Item</th><th>Valor</th><th>A√ß√£o</th></tr></thead><tbody id="tbody-investimentos"></tbody></table></div></div>
        <div id="config" class="content"><h2 class="section-title">‚öôÔ∏è Par√¢metros</h2><div class="card"><div class="form-grid" id="form-config-container">
            <div class="form-group"><label>Pre√ßo Unidade</label><input id="cfg-preco-und" type="number"></div>
            <div class="form-group"><label>Pre√ßo Combo</label><input id="cfg-preco-combo" type="number"></div>
            <div class="form-group"><label>Custo Insumo</label><input id="cfg-custo-insumo" type="number"></div>
            <div class="form-group"><label>Abat. Copo</label><input id="cfg-custo-copo" type="number"></div>
            <div class="form-group"><label>Tx Cr√©dito Ins</label><input id="cfg-taxa-cred-ins" type="number"></div>
            <div class="form-group"><label>Tx Cr√©dito Apr</label><input id="cfg-taxa-cred-apr" type="number"></div>
            <div class="form-group"><label>Tx D√©bito Ins</label><input id="cfg-taxa-deb-ins" type="number"></div>
            <div class="form-group"><label>Tx D√©bito Apr</label><input id="cfg-taxa-deb-apr" type="number"></div>
            <div class="form-group"><label>Tx Online</label><input id="cfg-taxa-cartao-online" type="number"></div>
        </div><button class="btn-submit" onclick="saveConfig()">Salvar</button></div></div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDctGxi1zGwJuHJ_eaFJn3TmErK9tWaGy0",
        authDomain: "pudimducaririapp.firebaseapp.com",
        databaseURL: "https://pudimducaririapp-default-rtdb.firebaseio.com",
        projectId: "pudimducaririapp",
        storageBucket: "pudimducaririapp.firebasestorage.app",
        messagingSenderId: "302932015479",
        appId: "1:302932015479:web:dd46d6c1c0b27ee6948972"
    };

    const ADMIN_EMAILS = ["luyan@pudim.com", "luyancosta.2015@gmail.com"]; 
    const VIEWER_EMAIL = "beatriz@pudim.com"; 
    
    let isOnline = firebaseConfig.apiKey && firebaseConfig.apiKey !== "COLE_SUA_API_KEY_AQUI";
    if(isOnline) firebase.initializeApp(firebaseConfig);

    // --- DADOS INJETADOS DO BACKUP ---
    let db = {
      "atacado": [
        {"cliente": "Davi (88 Smash)", "coposDevolvidos": 0, "data": "2026-02-17", "desconto": 0, "id": 1771340901079, "num": 4, "qtd": 12, "status": "N√ÉO PAGO", "totalBruto": 120, "totalLiquido": 120, "unitario": 10},
        {"cliente": "Davi (88 Smash)", "coposDevolvidos": 0, "data": "2026-02-15", "desconto": 0, "id": 202, "num": 3, "qtd": 6, "status": "PAGO", "totalBruto": 60, "totalLiquido": 60, "unitario": 10},
        {"cliente": "Conde Burguers", "coposDevolvidos": 0, "data": "2026-02-14", "desconto": 0, "id": 201, "num": 2, "qtd": 24, "status": "PAGO", "total": 263.76, "totalBruto": 263.76, "totalLiquido": 263.76, "unitario": 10.99},
        {"cliente": "Davi (88 Smash)", "coposDevolvidos": 0, "data": "2026-02-13", "desconto": 0, "id": 200, "num": 1, "qtd": 12, "status": "PAGO", "totalBruto": 120, "totalLiquido": 120, "unitario": 10}
      ],
      "config": {
        "custoCopo": 1.5, "custoInsumo": 5.95, "precoCombo": 40, "precoUnd": 15,
        "taxaCartaoOnline": 0, "taxaCredApr": 3.09, "taxaCredIns": 4.98, "taxaDebApr": 0.89, "taxaDebIns": 1.99
      },
      "despesas": [
        {"categoria": "INSUMOS", "data": "2026-02-17", "id": 1771365334300, "item": "Leite Integral", "num": 21, "qtd": 4, "total": 16, "unitario": 4},
        {"categoria": "EMBALAGEM", "data": "2026-02-17", "id": 1771340436969, "item": "Copos Americanos", "num": 20, "qtd": 72, "total": 92.88, "unitario": 1.29},
        {"categoria": "INSUMOS", "data": "2026-02-17", "id": 1771340391404, "item": "Leite Integral", "num": 19, "qtd": 3, "total": 12, "unitario": 4},
        {"categoria": "INSUMOS", "data": "2026-02-17", "id": 1771340354052, "item": "A√ß√∫car Cristal", "num": 18, "qtd": 7, "total": 20.93, "unitario": 2.99},
        {"categoria": "INSUMOS", "data": "2026-02-17", "id": 1771340324690, "item": "leite condensado tirol", "num": 17, "qtd": 27, "total": 156.33, "unitario": 5.79},
        {"categoria": "INSUMOS", "data": "2026-02-17", "id": 1771340306821, "item": "leite condensado natville", "num": 16, "qtd": 1, "total": 5.29, "unitario": 5.29},
        {"categoria": "INSUMOS", "data": "2026-02-17", "id": 1771335051959, "item": "Ovos", "num": 15, "qtd": 180, "total": 90, "unitario": 0.5},
        {"categoria": "GASTOS GERAIS", "data": "2026-02-15", "id": 113, "item": "CARIRI GAS", "num": 14, "qtd": 1, "total": 115, "unitario": 115},
        {"categoria": "INSUMOS", "data": "2026-02-15", "id": 109, "item": "LEITE", "num": 13, "qtd": 1, "total": 4, "unitario": 4},
        {"categoria": "INSUMOS", "data": "2026-02-15", "id": 107, "item": "OVOS", "num": 12, "qtd": 1, "total": 11.99, "unitario": 11.99},
        {"categoria": "INSUMOS", "data": "2026-02-15", "id": 106, "item": "LEITE", "num": 11, "qtd": 1, "total": 4.79, "unitario": 4.79},
        {"categoria": "INSUMOS", "data": "2026-02-15", "id": 101, "item": "OVOS", "num": 10, "qtd": 1, "total": 11.99, "unitario": 11.99},
        {"categoria": "INSUMOS", "data": "2026-02-14", "id": 112, "item": "COMPRAS MIX MATEUS", "num": 9, "qtd": 1, "total": 84.64, "unitario": 84.64},
        {"categoria": "INSUMOS", "data": "2026-02-14", "id": 105, "item": "LUVAS", "num": 8, "qtd": 1, "total": 30, "unitario": 30},
        {"categoria": "INSUMOS", "data": "2026-02-14", "id": 104, "item": "PAPEL ALUMINIO", "num": 7, "qtd": 1, "total": 4, "unitario": 4},
        {"categoria": "EMBALAGEM", "data": "2026-02-14", "id": 103, "item": "COPOS", "num": 6, "qtd": 72, "total": 86.4, "unitario": 1.2},
        {"categoria": "INSUMOS", "data": "2026-02-14", "id": 102, "item": "OVOS", "num": 5, "qtd": 1, "total": 11.99, "unitario": 11.99},
        {"categoria": "INSUMOS", "data": "2026-02-14", "id": 100, "item": "A√áUCAR", "num": 4, "qtd": 2, "total": 7.58, "unitario": 3.79},
        {"categoria": "MARKETING", "data": "2026-02-13", "id": 111, "item": "IMPULSIONAMENTO", "num": 3, "qtd": 1, "total": 30, "unitario": 30},
        {"categoria": "INSUMOS", "data": "2026-02-13", "id": 110, "item": "LEITE", "num": 2, "qtd": 2, "total": 8, "unitario": 4},
        {"categoria": "INSUMOS", "data": "2026-02-13", "id": 108, "item": "OVOS", "num": 1, "qtd": 1, "total": 5.51, "unitario": 5.51}
      ],
      "estoqueMov": [
        {"data": "2026-02-18", "desc": "Ajuste R√°pido", "id": 1771380292188, "item": "tampa", "qtd": 3, "tipo": "saida"},
        {"data": "2026-02-18", "desc": "Ajuste R√°pido", "id": 1771380280553, "item": "copo", "qtd": 31, "tipo": "saida"},
        {"data": "2026-02-18", "desc": "Ajuste R√°pido", "id": 1771379552090, "item": "pudim", "qtd": 3, "tipo": "saida"},
        {"data": "2026-02-17", "desc": "Compra", "id": 1771365389693, "item": "leite_integral", "qtd": 4000, "tipo": "entrada"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771359756418, "item": "pudim", "qtd": 1, "tipo": "entrada"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771335735025, "item": "sacola", "qtd": 14, "tipo": "saida"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771335711531, "item": "adesivo", "qtd": 90, "tipo": "saida"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771335688329, "item": "copo", "qtd": 2, "tipo": "saida"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771335625508, "item": "tampa", "qtd": 102, "tipo": "saida"},
        {"data": "2026-02-17", "desc": "Compras", "id": 1771335162981, "item": "leite_condensado", "qtd": 28, "tipo": "entrada"},
        {"data": "2026-02-17", "desc": "Compras", "id": 1771335152998, "item": "leite_integral", "qtd": 3000, "tipo": "entrada"},
        {"data": "2026-02-17", "desc": "Compras", "id": 1771335102225, "item": "acucar", "qtd": 7000, "tipo": "entrada"},
        {"data": "2026-02-17", "desc": "Compras", "id": 1771335067613, "item": "ovos", "qtd": 180, "tipo": "entrada"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771296080760, "item": "adesivo", "qtd": 24, "tipo": "entrada"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771294473837, "item": "adesivo", "qtd": 22, "tipo": "saida"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771294462407, "item": "pudim", "qtd": 2, "tipo": "saida"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771294432533, "item": "acucar", "qtd": 1000, "tipo": "entrada"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771294427725, "item": "ovos", "qtd": 24, "tipo": "entrada"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771294419367, "item": "leite_integral", "qtd": 1000, "tipo": "entrada"},
        {"data": "2026-02-17", "desc": "Ajuste R√°pido", "id": 1771294415195, "item": "leite_condensado", "qtd": 7, "tipo": "entrada"},
        {"data": "2026-02-16", "desc": "Ajuste R√°pido de Invent√°rio", "id": 1771212059145, "item": "colher", "qtd": 182, "tipo": "entrada"},
        {"data": "2026-02-16", "desc": "Ajuste R√°pido de Invent√°rio", "id": 1771212054902, "item": "adesivo", "qtd": 154, "tipo": "entrada"},
        {"data": "2026-02-16", "desc": "Ajuste R√°pido de Invent√°rio", "id": 1771212047234, "item": "sacola", "qtd": 92, "tipo": "entrada"},
        {"data": "2026-02-16", "desc": "Ajuste R√°pido de Invent√°rio", "id": 1771212036139, "item": "tampa", "qtd": 284, "tipo": "entrada"},
        {"data": "2026-02-16", "desc": "Ajuste R√°pido de Invent√°rio", "id": 1771212031633, "item": "copo", "qtd": 144, "tipo": "entrada"},
        {"data": "2026-02-16", "desc": "Ajuste R√°pido de Invent√°rio", "id": 1771212023854, "item": "pudim", "qtd": 104, "tipo": "entrada"}
      ],
      "investimentos": [
        {"data": "2026-02-08", "id": 13, "item": "200 COLHERES", "valor": 50.89},
        {"data": "2026-02-07", "id": 14, "item": "3 CAIXAS DE COPOS", "valor": 86.4},
        {"data": "2026-02-07", "id": 12, "item": "2kg de a√ßucar", "valor": 5.96},
        {"data": "2026-02-07", "id": 11, "item": "Adesivo Frente (bopp transparente) 300", "valor": 84.84},
        {"data": "2026-02-07", "id": 10, "item": "100 Sacolas 17x27cm", "valor": 60},
        {"data": "2026-02-07", "id": 9, "item": "15 Leite Condensado", "valor": 74.7},
        {"data": "2026-02-07", "id": 8, "item": "20 ovos", "valor": 10.98},
        {"data": "2026-02-07", "id": 7, "item": "200 tampas", "valor": 282.48},
        {"data": "2026-02-07", "id": 6, "item": "100 tampas", "valor": 143},
        {"data": "2026-02-07", "id": 5, "item": "Rosca para bico", "valor": 6.5},
        {"data": "2026-01-27", "id": 4, "item": "Impulsionamento - Primeira Arte", "valor": 50},
        {"data": "2026-01-21", "id": 3, "item": "Bico da Maquina", "valor": 13.75},
        {"data": "2026-01-21", "id": 2, "item": "12 copos americanos", "valor": 17.9},
        {"data": "2026-01-15", "id": 1, "item": "M√°quina Vapor", "valor": 279.18}
      ],
      "pagamentos": [
        {"data": "2026-02-17", "id": 1771362173058, "tipo": "Luyan", "valor": 5},
        {"data": "2026-02-17", "id": 1771340600366, "tipo": "Luyan", "valor": 30},
        {"data": "2026-02-17", "id": 1771295840999, "tipo": "Luyan", "valor": 33.83},
        {"data": "2026-02-17", "id": 1771295624480, "tipo": "Divida", "valor": 56},
        {"data": "2026-02-17", "id": 1771295594433, "tipo": "Beatriz", "valor": 21.61},
        {"data": "2026-02-17", "id": 1771294939680, "tipo": "Beatriz", "valor": 62.75},
        {"data": "2026-02-17", "id": 1771294909767, "tipo": "MaoObra", "valor": 148.32},
        {"data": "2026-02-16", "id": 1771209850760, "tipo": "Divida", "valor": 115},
        {"data": "2026-02-16", "id": 1771209832088, "tipo": "Divida", "valor": 15},
        {"data": "2026-02-16", "id": 1771205787274, "tipo": "Divida", "valor": 57}
      ],
      "producoes": [
        {"data": "2026-02-17", "id": 1771359750902, "num": 2, "qtd": 7},
        {"data": "2026-02-17", "id": 1771294452361, "num": 1, "qtd": 7}
      ],
      "vendas": [
        {"asaas": false, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771365465267, "num": 46, "pgto": "Dinheiro", "produto": "Combo (3 und)", "qtd": 1, "valorBruto": 40, "valorLiquido": 40, "valorTaxa": 0},
        {"asaas": false, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771360110663, "num": 45, "pgto": "Credito Aproximacao", "produto": "Combo", "qtd": 1, "valorBruto": 40, "valorLiquido": 38.764, "valorTaxa": 1.2359999999999998},
        {"asaas": false, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771360103325, "num": 44, "pgto": "Credito Aproximacao", "produto": "Pudim 1 Und", "qtd": 1, "valorBruto": 15, "valorLiquido": 14.5365, "valorTaxa": 0.46349999999999997},
        {"asaas": true, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771360094703, "num": 43, "pgto": "PIX", "produto": "Pudim 1 Und", "qtd": 1, "valorBruto": 15, "valorLiquido": 14.86, "valorTaxa": 0.14},
        {"asaas": false, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771360087306, "num": 42, "pgto": "Dinheiro", "produto": "Pudim 1 Und", "qtd": 1, "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"asaas": false, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771360058972, "num": 41, "pgto": "Credito Insercao", "produto": "Combo (3 und)", "qtd": 1, "valorBruto": 40, "valorLiquido": 38.008, "valorTaxa": 1.9920000000000002},
        {"asaas": true, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771360010439, "num": 40, "pgto": "PIX", "produto": "Pudim 1 Und", "qtd": 1, "valorBruto": 15, "valorLiquido": 14.86, "valorTaxa": 0.14},
        {"asaas": true, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771359857236, "num": 39, "pgto": "PIX", "produto": "Pudim 1 Und", "qtd": 1, "valorBruto": 15, "valorLiquido": 14.86, "valorTaxa": 0.14},
        {"asaas": false, "data": "2026-02-17", "desconto": 30, "entrega": 0, "id": 1771294632479, "num": 38, "pgto": "PIX", "produto": "Pudim 1 Und", "qtd": 2, "valorBruto": 30, "valorLiquido": 0, "valorTaxa": 0},
        {"asaas": true, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771294605441, "num": 37, "pgto": "PIX", "produto": "Combo (3 und)", "qtd": 1, "valorBruto": 40, "valorLiquido": 39.86, "valorTaxa": 0.14},
        {"asaas": true, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771294570555, "num": 36, "pgto": "PIX", "produto": "Pudim 1 Und", "qtd": 1, "valorBruto": 15, "valorLiquido": 14.86, "valorTaxa": 0.14},
        {"asaas": false, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771294558706, "num": 35, "pgto": "PIX", "produto": "Pudim 1 Und", "qtd": 1, "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"asaas": false, "data": "2026-02-17", "desconto": 0, "entrega": 0, "id": 1771294525404, "num": 34, "pgto": "PIX", "produto": "Combo (3 und)", "qtd": 1, "valorBruto": 40, "valorLiquido": 40, "valorTaxa": 0},
        {"asaas": false, "data": "2026-02-17", "desconto": 30, "entrega": 0, "id": 1771294516380, "num": 33, "pgto": "PIX", "produto": "Pudim 1 Und", "qtd": 2, "valorBruto": 30, "valorLiquido": 0, "valorTaxa": 0},
        {"data": "2026-02-15", "entrega": 0, "id": 331, "num": 32, "pgto": "Debito Insercao", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 39.64, "valorTaxa": 0.36},
        {"data": "2026-02-15", "entrega": 0, "id": 330, "num": 31, "pgto": "Credito Insercao", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 38.76, "valorTaxa": 1.24},
        {"data": "2026-02-15", "entrega": 0, "id": 329, "num": 30, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-15", "entrega": 0, "id": 328, "num": 29, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-14", "entrega": 0, "id": 327, "num": 28, "pgto": "Dinheiro", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 40, "valorTaxa": 0},
        {"data": "2026-02-14", "entrega": 0, "id": 326, "num": 27, "pgto": "Credito Insercao", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 38.76, "valorTaxa": 1.24},
        {"data": "2026-02-14", "entrega": 0, "id": 325, "num": 26, "pgto": "Debito Insercao", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 39.64, "valorTaxa": 0.36},
        {"data": "2026-02-14", "entrega": 0, "id": 324, "num": 25, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-14", "entrega": 0, "id": 323, "num": 24, "pgto": "PIX", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 40, "valorTaxa": 0},
        {"data": "2026-02-14", "entrega": 0, "id": 322, "num": 23, "pgto": "PIX", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 40, "valorTaxa": 0},
        {"data": "2026-02-14", "entrega": 0, "id": 321, "num": 22, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-14", "entrega": 0, "id": 320, "num": 21, "pgto": "Credito Insercao", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 38.68, "valorTaxa": 1.32},
        {"data": "2026-02-14", "entrega": 0, "id": 319, "num": 20, "pgto": "Credito Insercao", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 38.76, "valorTaxa": 1.24},
        {"data": "2026-02-14", "entrega": 0, "id": 318, "num": 19, "pgto": "Dinheiro", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 40, "valorTaxa": 0},
        {"data": "2026-02-14", "entrega": 0, "id": 317, "num": 18, "pgto": "Dinheiro", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 40, "valorTaxa": 0},
        {"data": "2026-02-13", "entrega": 0, "id": 316, "num": 17, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-13", "entrega": 0, "id": 315, "num": 16, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-13", "entrega": 0, "id": 314, "num": 15, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-13", "entrega": 0, "id": 313, "num": 14, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-13", "entrega": 0, "id": 312, "num": 13, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-13", "entrega": 0, "id": 311, "num": 12, "pgto": "PIX", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 40, "valorTaxa": 0},
        {"data": "2026-02-13", "entrega": 0, "id": 310, "num": 11, "pgto": "PIX", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 40, "valorTaxa": 0},
        {"data": "2026-02-12", "entrega": 0, "id": 309, "num": 10, "pgto": "Debito Insercao", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 14.53, "valorTaxa": 0.47},
        {"data": "2026-02-12", "entrega": 0, "id": 308, "num": 9, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-12", "entrega": 0, "id": 307, "num": 8, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-12", "entrega": 0, "id": 306, "num": 7, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-12", "entrega": 0, "id": 305, "num": 6, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-12", "entrega": 0, "id": 304, "num": 5, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-12", "entrega": 0, "id": 303, "num": 4, "pgto": "PIX", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 15, "valorTaxa": 0},
        {"data": "2026-02-12", "entrega": 0, "id": 302, "num": 3, "pgto": "Credito Insercao", "produto": "Pudim 1 Und", "valorBruto": 15, "valorLiquido": 14.54, "valorTaxa": 0.46},
        {"data": "2026-02-12", "entrega": 0, "id": 301, "num": 2, "pgto": "PIX", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 40, "valorTaxa": 0},
        {"data": "2026-02-12", "entrega": 0, "id": 300, "num": 1, "pgto": "PIX", "produto": "Combo (3 und)", "valorBruto": 40, "valorLiquido": 40, "valorTaxa": 0}
      ]
    };

    let currentUserRole = 'viewer';
    let editingItem = { lista: null, id: null };

    const formatMoney = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(Number(val)||0);
    const formatData = (date) => date ? new Date(date + "T00:00:00").toLocaleDateString('pt-BR') : '';
    const sortByDateDesc = (a, b) => new Date(b.data) - new Date(a.data) || (b.id - a.id);
    const getNextNum = (arr) => arr.length > 0 ? Math.max(...arr.map(x => x.num || 0)) + 1 : 1;

    function showToast(msg) { const t = document.getElementById("toast"); t.innerText = msg; t.classList.add("show"); setTimeout(() => t.classList.remove("show"), 3000); }

    // --- LOGIN ---
    function fazerLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        firebase.auth().signInWithEmailAndPassword(email, pass).catch(err => {
            document.getElementById('login-error').innerText = "Erro no acesso.";
            document.getElementById('login-error').style.display = 'block';
        });
    }

    function fazerLogout() { firebase.auth().signOut(); window.location.reload(); }

    // --- FECHAMENTO WHATSAPP ---
    function enviarFechamentoWhatsApp() {
        const hoje = new Date().toISOString().split('T')[0];
        const vHoje = db.vendas.filter(v => v.data === hoje);
        const aHoje = db.atacado.filter(a => a.data === hoje && a.status === 'PAGO');
        const dHoje = db.despesas.filter(d => d.data === hoje);

        let vQtd = 0, vLiq = 0;
        let pPixP = 0, pPixA = 0, pDin = 0, pCard = 0;

        vHoje.forEach(v => {
            const q = (v.produto === 'Combo' ? 3 : 1) * Number(v.qtd || 1);
            const val = Number(v.valorLiquido || 0);
            vQtd += q; vLiq += val;
            if(v.pgto === 'PIX') { if(v.asaas) pPixA += val; else pPixP += val; }
            else if(v.pgto === 'Dinheiro') pDin += val;
            else pCard += val;
        });

        let aQtd = 0, aLiq = 0;
        aHoje.forEach(a => {
            aQtd += Number(a.qtd || 0);
            aLiq += Number(a.totalLiquido || 0);
        });

        let totalSair = 0;
        dHoje.forEach(d => totalSair += Number(d.total || 0));

        const saldoDia = (vLiq + aLiq) - totalSair;

        let txt = `*üìä FECHAMENTO PUDIM DU CARIRI - ${hoje.split('-').reverse().join('/')}*\n\n`;
        txt += `*üõí VAREJO*\n- Pudins: ${vQtd} un\n- Total L√≠quido: ${formatMoney(vLiq)}\n\n`;
        txt += `*üì¶ ATACADO*\n- Pudins: ${aQtd} un\n- Total L√≠quido: ${formatMoney(aLiq)}\n\n`;
        txt += `*üí∏ DESPESAS DO DIA*\n- Total Sa√≠da: ${formatMoney(totalSair)}\n\n`;
        txt += `*üí∞ RESUMO DE RECEBIMENTO*\n`;
        txt += `‚Ä¢ PIX (Pessoal): ${formatMoney(pPixP)}\n`;
        txt += `‚Ä¢ PIX (Asaas): ${formatMoney(pPixA)}\n`;
        txt += `‚Ä¢ Dinheiro: ${formatMoney(pDin)}\n`;
        txt += `‚Ä¢ Cart√µes/Link: ${formatMoney(pCard)}\n\n`;
        txt += `*üíé SALDO FINAL (LUCRO HOJE)*\nüëâ *${formatMoney(saldoDia)}*`;

        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(txt)}`, '_blank');
    }

    // --- CORE ---
    function init() {
        // Fallback para quem n√£o tem conex√£o ou conta, usar os dados locais injetados
        const local = localStorage.getItem('pudimDuCaririDB');
        if(!local) localStorage.setItem('pudimDuCaririDB', JSON.stringify(db)); // Salva o injetado
        
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                const email = user.email.toLowerCase();
                if(!ADMIN_EMAILS.includes(email) && email !== VIEWER_EMAIL) { firebase.auth().signOut(); return; }
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                currentUserRole = ADMIN_EMAILS.includes(email) ? 'admin' : 'viewer';
                if(currentUserRole === 'viewer') document.body.classList.add('viewer-mode');
                document.getElementById('user-badge').innerText = email;

                firebase.database().ref('pudimAppDB').on('value', snap => {
                    if(snap.exists()) {
                        const data = snap.val();
                        // Mescla o backup com o firebase se necess√°rio, mas prioriza a nuvem
                        db = data;
                        // Normaliza arrays (firebase pode retornar objetos)
                        db.vendas = Object.values(db.vendas || {});
                        db.atacado = Object.values(db.atacado || {});
                        db.despesas = Object.values(db.despesas || {});
                        db.pagamentos = Object.values(db.pagamentos || {});
                        db.producoes = Object.values(db.producoes || {});
                        db.estoqueMov = Object.values(db.estoqueMov || {});
                        db.investimentos = Object.values(db.investimentos || {});
                        updateAll();
                    } else if (currentUserRole === 'admin') {
                        // Se nuvem vazia, sobe o backup
                        firebase.database().ref('pudimAppDB').set(db);
                    }
                });
            }
        });
        // Renderiza inicial com os dados injetados (mesmo sem login ainda)
        updateAll();
    }

    function updateAll() {
        updateDashboard();
        renderVendas();
        renderAtacado();
        renderDespesas();
        renderRateio();
        renderEstoque();
        renderExtrato();
        renderInvestimentos();
        loadConfigUI();
    }

    function updateDashboard() {
        const filter = document.getElementById('dash-filter-month').value;
        const fFn = (d) => !filter || d.data.startsWith(filter);

        let vLiq = 0, vQtd = 0, vMo = 0;
        let sPixP = 0, sPixA = 0, sDin = 0, sCred = 0, sDeb = 0, sOn = 0;

        db.vendas.filter(fFn).forEach(v => {
            const val = Number(v.valorLiquido||0);
            const q = (v.produto.includes('Combo') ? 3 : 1) * Number(v.qtd||1);
            vLiq += val; vQtd += q;
            const lucBase = val - (q * (db.config.custoInsumo || 5.95));
            vMo += lucBase * 0.20;

            if(v.pgto === 'PIX') { if(v.asaas) sPixA += val; else sPixP += val; }
            else if(v.pgto === 'Dinheiro') sDin += val;
            else if(v.pgto.includes('Credito')) sCred += val;
            else if(v.pgto.includes('Debito')) sDeb += val;
            else if(v.pgto.includes('Cartao Online')) sOn += val;
        });

        document.getElementById('v-dash-liquido').innerText = formatMoney(vLiq);
        document.getElementById('v-dash-qtd').innerText = vQtd;
        document.getElementById('v-dash-mo').innerText = formatMoney(vMo);
        document.getElementById('v-dash-lucro-restante').innerText = formatMoney(vLiq * 0.30); 

        // Atualiza Mini Cards da Aba Varejo
        document.getElementById('v-sum-pix-p').innerText = formatMoney(sPixP);
        document.getElementById('v-sum-pix-a').innerText = formatMoney(sPixA);
        document.getElementById('v-sum-dinheiro').innerText = formatMoney(sDin);
        document.getElementById('v-sum-credito').innerText = formatMoney(sCred);
        document.getElementById('v-sum-debito').innerText = formatMoney(sDeb);
        document.getElementById('v-sum-online').innerText = formatMoney(sOn);

        // Cards Atacado
        let aLiq = 0, aQtd = 0;
        db.atacado.filter(fFn).filter(a => a.status === 'PAGO').forEach(a => {
            aLiq += Number(a.totalLiquido || 0);
            aQtd += Number(a.qtd || 0);
        });
        document.getElementById('a-dash-liquido').innerText = formatMoney(aLiq);
        document.getElementById('a-dash-qtd').innerText = aQtd;

        // Caixa Global
        let totalGlobal = vLiq + aLiq; // Somar todos os tempos se n√£o tiver filtro, mas aqui usa o filtrado para o dashboard. 
        // Para o "Global Total" precisamos de tudo sem filtro:
        let gVLiq = db.vendas.reduce((acc, v) => acc + Number(v.valorLiquido||0), 0);
        let gALiq = db.atacado.filter(a=>a.status==='PAGO').reduce((acc,a)=>acc+Number(a.totalLiquido||a.total||0),0);
        let gDesp = db.despesas.reduce((acc,d)=>acc+Number(d.total||0),0);
        let gPag = db.pagamentos.reduce((acc,p)=>acc+Number(p.valor||0),0);
        
        document.getElementById('global-total-conta').innerText = formatMoney((gVLiq + gALiq) - gDesp - gPag);
    }

    function renderVendas() {
        document.getElementById('tbody-vendas').innerHTML = (db.vendas || []).sort(sortByDateDesc).map(v => `
            <tr><td>#${v.num||''}</td><td>${formatData(v.data)}</td><td>${v.produto} (${v.qtd})</td>
            <td style="font-size:0.85rem">${v.pgto}${v.asaas ? ' (Asaas)' : ''}</td>
            <td style="font-weight:bold">${formatMoney(v.valorLiquido)}</td>
            <td><button class="btn-icon btn-delete" onclick="deleteItem('vendas', ${v.id})">üóëÔ∏è</button></td></tr>
        `).join('');
    }

    function renderAtacado() {
        document.getElementById('tbody-atacado').innerHTML = (db.atacado || []).sort(sortByDateDesc).map(a => `
            <tr><td>${formatData(a.data)}</td><td>${a.cliente}</td><td>${a.qtd}</td><td>${formatMoney(a.totalLiquido)}</td>
            <td style="color:${a.status==='PAGO'?'green':'red'}">${a.status}</td>
            <td><button class="btn-icon btn-delete" onclick="deleteItem('atacado', ${a.id})">üóëÔ∏è</button></td></tr>
        `).join('');
    }

    function addVenda() {
        const data = document.getElementById('v-data').value;
        const prod = document.getElementById('v-produto').value;
        const qtd = parseInt(document.getElementById('v-qtd').value);
        const pgto = document.getElementById('v-pgto').value;
        const isAsaas = document.getElementById('v-asaas').checked;
        const desc = parseFloat(document.getElementById('v-desconto').value);

        if(!data) return alert("Preencha a data!");

        const preco = prod === 'Combo' ? (db.config.precoCombo || 40) : (db.config.precoUnd || 15);
        const bruto = preco * qtd;
        
        let taxaPerc = 0;
        if(pgto.includes('Credito Insercao')) taxaPerc = db.config.taxaCredIns;
        else if(pgto.includes('Credito Aproximacao')) taxaPerc = db.config.taxaCredApr;
        else if(pgto.includes('Debito Insercao')) taxaPerc = db.config.taxaDebIns;
        else if(pgto.includes('Debito Aproximacao')) taxaPerc = db.config.taxaDebApr;
        else if(pgto.includes('Cartao Online')) taxaPerc = db.config.taxaCartaoOnline;

        let taxaValor = (bruto - desc) * (taxaPerc / 100);
        if(pgto === 'PIX' && isAsaas) taxaValor = 0.14;

        const liq = (bruto - desc) - taxaValor;

        const novo = { id: Date.now(), num: getNextNum(db.vendas), data, produto: prod, qtd, pgto, asaas: isAsaas, valorBruto: bruto, valorLiquido: liq };
        db.vendas.push(novo); saveData();
    }

    function addAtacado() {
        const novo = { 
            id: Date.now(), 
            data: document.getElementById('a-data').value, 
            cliente: document.getElementById('a-cliente').value, 
            qtd: document.getElementById('a-qtd').value, 
            totalLiquido: Number(document.getElementById('a-qtd').value) * Number(document.getElementById('a-valor').value), 
            status: document.getElementById('a-status').value 
        };
        db.atacado.push(novo); saveData();
    }

    function addDespesa() {
        const d = { 
            id: Date.now(), 
            data: document.getElementById('d-data').value, 
            item: document.getElementById('d-item').value, 
            qtd: document.getElementById('d-qtd').value, 
            unitario: document.getElementById('d-valor').value,
            total: Number(document.getElementById('d-qtd').value) * Number(document.getElementById('d-valor').value), 
            categoria: document.getElementById('d-categoria').value 
        };
        db.despesas.push(d); saveData();
    }

    function renderDespesas() {
        document.getElementById('tbody-despesas').innerHTML = db.despesas.sort(sortByDateDesc).map(d => 
            `<tr><td>${formatData(d.data)}</td><td>${d.item}</td><td>${formatMoney(d.total)}</td><td>${d.categoria}</td>
            <td><button class="btn-icon btn-delete" onclick="deleteItem('despesas', ${d.id})">üóëÔ∏è</button></td></tr>`
        ).join('');
    }

    function renderRateio() { /* Simplificado */ }
    function renderEstoque() { 
        // Renderiza Historico
        document.getElementById('tbody-producoes').innerHTML = db.producoes.sort(sortByDateDesc).map(p => `<tr><td>${formatData(p.data)}</td><td>${p.qtd}</td><td><button class="btn-icon btn-delete" onclick="deleteItem('producoes', ${p.id})">üóëÔ∏è</button></td></tr>`).join('');
        document.getElementById('tbody-estoquemov').innerHTML = db.estoqueMov.sort(sortByDateDesc).map(m => `<tr><td>${formatData(m.data)}</td><td>${m.item}</td><td>${m.tipo==='entrada'?'+':'-'}${m.qtd}</td><td><button class="btn-icon btn-delete" onclick="deleteItem('estoqueMov', ${m.id})">üóëÔ∏è</button></td></tr>`).join('');
    }
    function renderExtrato() {
        document.getElementById('tbody-pagamentos').innerHTML = db.pagamentos.sort(sortByDateDesc).map(p => 
            `<tr><td>${formatData(p.data)}</td><td>${p.tipo}</td><td>${formatMoney(p.valor)}</td><td><button class="btn-icon btn-delete" onclick="deleteItem('pagamentos', ${p.id})">üóëÔ∏è</button></td></tr>`
        ).join('');
    }
    function renderInvestimentos() {
        document.getElementById('tbody-investimentos').innerHTML = db.investimentos.sort(sortByDateDesc).map(i => 
            `<tr><td>${formatData(i.data)}</td><td>${i.item}</td><td>${formatMoney(i.valor)}</td><td><button class="btn-icon btn-delete" onclick="deleteItem('investimentos', ${i.id})">üóëÔ∏è</button></td></tr>`
        ).join('');
    }

    function loadConfigUI() {
        if(!db.config) return;
        document.getElementById('cfg-preco-und').value = db.config.precoUnd;
        document.getElementById('cfg-preco-combo').value = db.config.precoCombo;
        document.getElementById('cfg-custo-insumo').value = db.config.custoInsumo;
        document.getElementById('cfg-custo-copo').value = db.config.custoCopo;
        document.getElementById('cfg-taxa-cred-ins').value = db.config.taxaCredIns;
        document.getElementById('cfg-taxa-cred-apr').value = db.config.taxaCredApr;
        document.getElementById('cfg-taxa-deb-ins').value = db.config.taxaDebIns;
        document.getElementById('cfg-taxa-deb-apr').value = db.config.taxaDebApr;
        document.getElementById('cfg-taxa-cartao-online').value = db.config.taxaCartaoOnline;
    }

    function saveConfig() {
        db.config.precoUnd = parseFloat(document.getElementById('cfg-preco-und').value);
        db.config.precoCombo = parseFloat(document.getElementById('cfg-preco-combo').value);
        db.config.custoInsumo = parseFloat(document.getElementById('cfg-custo-insumo').value);
        db.config.custoCopo = parseFloat(document.getElementById('cfg-custo-copo').value);
        db.config.taxaCredIns = parseFloat(document.getElementById('cfg-taxa-cred-ins').value);
        db.config.taxaCredApr = parseFloat(document.getElementById('cfg-taxa-cred-apr').value);
        db.config.taxaDebIns = parseFloat(document.getElementById('cfg-taxa-deb-ins').value);
        db.config.taxaDebApr = parseFloat(document.getElementById('cfg-taxa-deb-apr').value);
        db.config.taxaCartaoOnline = parseFloat(document.getElementById('cfg-taxa-cartao-online').value);
        saveData();
    }

    function deleteItem(list, id) { if(confirm("Apagar?")) { db[list] = db[list].filter(i => i.id !== id); saveData(); } }
    function saveData() { 
        localStorage.setItem('pudimDuCaririDB', JSON.stringify(db));
        if(currentUserRole === 'admin' && isOnline) firebase.database().ref('pudimAppDB').set(db); 
        showToast("Sincronizado!"); updateAll(); 
    }
    function switchTab(id) { 
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
    }
    function toggleAsaas() { document.getElementById('asaas-group').style.display = document.getElementById('v-pgto').value === 'PIX' ? 'flex' : 'none'; }
    function limparFiltro() { document.getElementById('dash-filter-month').value = ''; updateDashboard(); }

    init();
</script>
</body>
</html>
